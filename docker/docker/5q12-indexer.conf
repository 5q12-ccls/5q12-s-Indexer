# Enhanced 5q12-indexer.conf with X-Accel-Redirect and clean URL routing
server {
    listen 5012;
    server_name _;
    
    # Document root
    root /www/indexer;
    index index.php;
    
    # Logs
    access_log /var/log/nginx/indexer_access.log;
    error_log /var/log/nginx/indexer_error.log warn;
    
    # CRITICAL: Internal location for X-Accel-Redirect file serving
    # This allows nginx to serve files directly after PHP authorization
    location /internal-files/ {
        internal;  # Only accessible via X-Accel-Redirect
        alias /files/;  # Map to Docker volume mounted files directory
        
        # Optimize for large file downloads
        sendfile on;
        sendfile_max_chunk 1m;
        tcp_nopush on;
        tcp_nodelay on;
        
        # Support range requests for resume capability
        add_header Accept-Ranges bytes;
        
        # No additional processing needed
        expires off;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }
    
    # Allow CSS and font files from .indexer_files/local_api/style directory
    location ~ ^/\.indexer_files/local_api/style/.*\.(css|woff2)$ {
        location ~* \.css$ {
            add_header Content-Type "text/css" always;
        }
        location ~* \.woff2$ {
            add_header Content-Type "font/woff2" always;
        }
        
        expires 1d;
        add_header Cache-Control "public, immutable" always;
        add_header X-Content-Type-Options "nosniff" always;
        try_files $uri =404;
    }
    
    # Allow PNG files from .indexer_files/icons directory
    location ~ ^/\.indexer_files/icons/.*\.png$ {
        add_header Content-Type "image/png" always;
        expires 7d;
        add_header Cache-Control "public, immutable" always;
        add_header X-Content-Type-Options "nosniff" always;
        try_files $uri =404;
    }
    
    # Allow favicon files from .indexer_files/favicon directory
    location ~ ^/\.indexer_files/favicon/.*\.(ico|png)$ {
        # Set proper MIME types
        location ~* \.ico$ {
            add_header Content-Type "image/x-icon" always;
        }
        location ~* \.png$ {
            add_header Content-Type "image/png" always;
        }
        
        expires 7d;
        add_header Cache-Control "public, immutable" always;
        add_header X-Content-Type-Options "nosniff" always;
        try_files $uri =404;
    }
    
    # Deny access to other .indexer_files subdirectories
    location ~ ^/\.indexer_files/(?!local_api/style/|icons/|favicon/) {
        deny all;
        return 404;
    }
    
    # Main indexer application - handle all requests through index.php with clean URLs
    location / {
        # Add security headers for non-download requests
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        
        # Route everything through index.php for clean URL handling
        try_files $uri $uri/ /index.php$is_args$args;
    }
    
    # PHP handler with optimizations for downloads
    location ~ \.php$ {
        # Only allow index.php to be executed
        if ($uri != "/index.php") {
            return 404;
        }
        
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        
        # Extended timeouts for large operations
        fastcgi_read_timeout 7200;
        fastcgi_send_timeout 7200;
        
        # Disable buffering for downloads to allow X-Accel-Redirect
        fastcgi_buffering off;
        fastcgi_request_buffering off;
        
        # Don't add security headers for downloads (they're added in location / block)
        set $is_download 0;
        if ($arg_download) {
            set $is_download 1;
        }
    }
    
    # Deny configuration files
    location ~ /\.(ht|git|env|log|sqlite|json)$ {
        deny all;
        return 404;
    }
    
    # Deny backup files
    location ~ \.(bak|backup|old|tmp|temp|swp|swo|~)$ {
        deny all;
        return 404;
    }
    
    # Deny access to common sensitive filenames
    location ~ ^/(config|configuration|settings|private|admin|api|\.well-known) {
        deny all;
        return 404;
    }

    # Block common attack patterns
    location ~ /(wp-|wordpress|admin|phpmyadmin|mysql|database) {
        deny all;
        return 404;
    }
    
    # Static files caching (for allowed files only)
    location ~* ^/\.indexer_files/(local_api/style/|icons/|favicon/).*\.(css|js|png|jpg|jpeg|gif|ico|svg|woff2)$ {
        expires 1M;
        add_header Cache-Control "public, immutable" always;
        add_header X-Content-Type-Options "nosniff" always;
    }
    
    # Large file limits
    client_max_body_size 200G;
    client_body_buffer_size 128k;
    client_header_buffer_size 4k;
    large_client_header_buffers 8 8k;
    
    # Block suspicious user agents
    if ($http_user_agent ~* "(?:acunetix|fhscan|uniscan|sqlmap|bsqlbf|arachni|nikto)" ) {
        return 444;
    }
    
    # Block unwanted methods
    if ($request_method !~ ^(GET|HEAD|POST)$ ) {
        return 444;
    }
}